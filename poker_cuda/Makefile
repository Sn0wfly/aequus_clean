# ðŸš€ POKER CUDA CFR - Makefile
# ===========================
# Compiles CUDA kernels and creates shared library for Python

# CUDA compiler and flags
NVCC = nvcc
CUDA_FLAGS = -O3 -arch=sm_70 --compiler-options '-fPIC' -shared -Xcompiler -fopenmp
CUDA_LIBS = -lcurand

# Determine CUDA path automatically
CUDA_PATH ?= $(shell which nvcc | sed 's/\/bin\/nvcc//')
ifeq ($(CUDA_PATH),)
	CUDA_PATH = /usr/local/cuda
endif

# Include and library paths
CUDA_INCLUDE = -I$(CUDA_PATH)/include
CUDA_LIB_PATH = -L$(CUDA_PATH)/lib64

# Source files
HAND_EVALUATOR_SRC = hand_evaluator.cu
CFR_KERNELS_SRC = cfr_kernels.cu
OUTPUT_LIB = libpoker_cuda.so

# Build targets
.PHONY: all clean test install benchmark

all: $(OUTPUT_LIB)

$(OUTPUT_LIB): $(HAND_EVALUATOR_SRC) $(CFR_KERNELS_SRC)
	@echo "ðŸ”¥ Compiling CUDA Poker CFR kernels..."
	@echo "CUDA Path: $(CUDA_PATH)"
	$(NVCC) $(CUDA_FLAGS) $(CUDA_INCLUDE) $(CUDA_LIB_PATH) \
		$(HAND_EVALUATOR_SRC) $(CFR_KERNELS_SRC) \
		$(CUDA_LIBS) -o $(OUTPUT_LIB)
	@echo "âœ… Compilation successful: $(OUTPUT_LIB)"
	@ls -lh $(OUTPUT_LIB)

# Quick compile for development
quick:
	$(NVCC) -O2 -arch=sm_70 --compiler-options '-fPIC' -shared \
		$(CUDA_INCLUDE) $(CUDA_LIB_PATH) \
		$(HAND_EVALUATOR_SRC) $(CFR_KERNELS_SRC) \
		-lcurand -o $(OUTPUT_LIB)

# Production build with maximum optimization
production:
	@echo "ðŸ† Production build with maximum optimization..."
	$(NVCC) -O3 -arch=sm_70,sm_75,sm_80 --compiler-options '-fPIC -march=native' \
		-shared -Xcompiler -fopenmp --use_fast_math \
		$(CUDA_INCLUDE) $(CUDA_LIB_PATH) \
		$(HAND_EVALUATOR_SRC) $(CFR_KERNELS_SRC) \
		-lcurand -lcublas -o $(OUTPUT_LIB)
	@echo "âœ… Production build complete"

# Test compilation and basic functionality
test: $(OUTPUT_LIB)
	@echo "ðŸ§ª Testing CUDA library..."
	python3 -c "
import ctypes
lib = ctypes.CDLL('./$(OUTPUT_LIB)')
print('âœ… Library loaded successfully')
print('Available functions:')
print('  - cuda_evaluate_single_hand')
print('  - cuda_init_cfr_trainer') 
print('  - cuda_cfr_train_step')
print('  - cuda_cleanup_cfr_trainer')
"

# Run Python trainer test
test_trainer: $(OUTPUT_LIB)
	@echo "ðŸš€ Testing CUDA CFR trainer..."
	python3 cuda_trainer.py

# Performance benchmark
benchmark: $(OUTPUT_LIB)
	@echo "ðŸ“Š Running performance benchmark..."
	python3 -c "
from cuda_trainer import benchmark_cuda_vs_alternatives
results = benchmark_cuda_vs_alternatives(batch_size=512)
print('Benchmark complete!')
"

# Install to system (optional)
install: $(OUTPUT_LIB)
	@echo "ðŸ“¦ Installing CUDA library..."
	sudo cp $(OUTPUT_LIB) /usr/local/lib/
	sudo ldconfig
	@echo "âœ… Installed to /usr/local/lib/"

# Debug build with symbols
debug:
	$(NVCC) -g -G -O0 -arch=sm_70 --compiler-options '-fPIC' -shared \
		$(CUDA_INCLUDE) $(CUDA_LIB_PATH) \
		$(HAND_EVALUATOR_SRC) $(CFR_KERNELS_SRC) \
		-lcurand -o $(OUTPUT_LIB)
	@echo "ðŸ› Debug build complete"

# Check CUDA environment
check_cuda:
	@echo "ðŸ” CUDA Environment Check:"
	@echo "NVCC Version:"
	@nvcc --version || echo "âŒ nvcc not found"
	@echo ""
	@echo "CUDA Devices:"
	@nvidia-smi || echo "âŒ nvidia-smi not found" 
	@echo ""
	@echo "CUDA Path: $(CUDA_PATH)"
	@echo "Include: $(CUDA_INCLUDE)"
	@echo "Lib Path: $(CUDA_LIB_PATH)"

# Memory usage analysis
analyze_memory: $(OUTPUT_LIB)
	@echo "ðŸ§® Memory usage analysis..."
	python3 -c "
from cuda_trainer import CUDAPokerCFR
trainer = CUDAPokerCFR(batch_size=512)
print(f'GPU Memory: {trainer._calculate_memory_usage():.1f} MB')
print('Memory breakdown:')
print('  - Regrets: 1.1 MB')  
print('  - Strategy: 1.1 MB')
print('  - Game simulation: 0.5 MB')
print('  - Random states: 24 MB')
print('  - Total: ~27 MB for batch_size=512')
"

# Performance tuning guide
tune:
	@echo "âš¡ Performance Tuning Guide:"
	@echo ""
	@echo "1. Batch Size Optimization:"
	@echo "   - Start with batch_size=512"
	@echo "   - Increase until GPU memory ~80% full"
	@echo "   - Monitor with: nvidia-smi"
	@echo ""
	@echo "2. CUDA Architecture:"
	@echo "   - RTX 3090/4090: -arch=sm_86"
	@echo "   - RTX 2080/3080: -arch=sm_75" 
	@echo "   - GTX 1080: -arch=sm_61"
	@echo ""
	@echo "3. Expected Performance:"
	@echo "   - RTX 4090: >200 it/s"
	@echo "   - RTX 3090: >150 it/s"
	@echo "   - RTX 3080: >100 it/s"

# Clean build files
clean:
	rm -f $(OUTPUT_LIB) *.o *.so
	@echo "ðŸ§¹ Cleaned build files"

# Show help
help:
	@echo "ðŸš€ CUDA Poker CFR - Build System"
	@echo "================================"
	@echo ""
	@echo "Available targets:"
	@echo "  all         - Build shared library (default)"
	@echo "  quick       - Fast development build"
	@echo "  production  - Optimized production build"
	@echo "  test        - Test library loading"
	@echo "  test_trainer- Test full Python trainer"
	@echo "  benchmark   - Run performance benchmark"
	@echo "  debug       - Build with debug symbols"
	@echo "  check_cuda  - Check CUDA environment"
	@echo "  tune        - Show performance tuning guide"
	@echo "  clean       - Remove build files"
	@echo "  install     - Install to system (sudo)"
	@echo ""
	@echo "Usage examples:"
	@echo "  make              # Standard build"
	@echo "  make production   # Maximum performance"
	@echo "  make test_trainer # Full test"
	@echo "  make benchmark    # Performance test"

# Default help when no target specified
.DEFAULT_GOAL := help 